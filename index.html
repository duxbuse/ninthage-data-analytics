<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

  <link href="https://fonts.googleapis.com/css?family=Bakbak+One:300,400" rel="stylesheet">

  <style>
    h1,
    button,
    label {
      font-family: "Bakbak One";
      color: rgb(218, 218, 218);
    }

    h1 {
      /* font-size: 50px; */
      background: -webkit-linear-gradient(#eee, rgb(248, 1, 1));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    label {
      background-color: rgba(0, 0, 0, 0.281);
      border-radius: 2px;
    }

    #bg {
      background-image: url("https://www.the-ninth-age.com/community/gallery/userImages/ab/12782-ab2064eb.jpg");
      background-size: 100%;
      background-repeat: repeat-y;
      min-height: 100vh;
    }

    pre {
      background: #efefff;
      word-wrap: break-word;
      box-decoration-break: clone;
      padding: .1rem .3rem .2rem;
      border-radius: .2rem;
    }
  </style>
  <title>9th Age Data Analytics</title>
</head>

<body>
  <div id="bg" class="bg-image">
    <div class="mask">
      <div class="container-fluid">
        <!-- Title info -->
        <div class="row justify-content-center">
          <div class="col-md-3 mt-4">
            <h1>Report a Game</h1>
          </div>
        </div>
        <div class="row mt-4"></div>

        <form class="needs-validation"
          action="https://us-central1-ninthage-data-analytics.cloudfunctions.net/function_game_report" method="POST">
          <!-- Player info -->
          <div class="row justify-content-center">
            <div class="col">
              <!-- Player 1 -->
              <div class="form-group" data-bs-toggle="tooltip" data-bs-placement="top" title="EXAMPLE:
              Warriors of the Dark Gods
              830 - Exalted Herald, General
              830 - Exalted Herald
              964 - 24x Warriors, Great Weapon, Sloth, Standard Bearer (Zealots' Banner), Musician, Champion
              690 - 5x Feldraks, Paired Weapons, Standard Bearer (Wasteland Torch), Musician, Champion
              200 - Chimera
              490 - Feldrak Elder, Paired Weapons
              490 - Feldrak Elder, Paired Weapons
              4494
              ">
                <label for="player1_army">Player 1's List *</label>
                <textarea id="player1_army" class="form-control shadow" name="player1_army" rows="3" required
                  placeholder="new recruit format - first line must be army name"></textarea>
              </div>
              <div class="form-group mt-4 d-block d-none">
                <label id="player1_army_formatted_label">Player 1's List Formatted</label>
                <pre id="player1_army_formatted"></pre>
              </div>


              <div class="form-group mt-4">
                <label for="player1_name">Player 1's Name</label>
                <input type="text" class="form-control shadow" name="player1_name" placeholder="bob">
              </div>
              <div class="form-group mt-2 has-validation">
                <label for="player1_score">Player 1's Score - Including Secondary</label>
                <input type="number" min="0" max="20" class="form-control shadow" name="player1_score" placeholder="20">
              </div>
              <div class="form-group mt-2">
                <label for="player1_vps">Player 1's Victory Points</label>
                <input type="number" class="form-control shadow" name="player1_vps" placeholder="0-4900">
              </div>



              <div class="form-check mt-2">
                <input class="form-check-input" type="radio" name="won_secondary" value="player1">
                <label class="form-check-label">
                  Won Secondary Objective
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="who_deployed" value="player1">
                <label class="form-check-label">
                  Deployed First
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="dropped_all" value="player1">
                <label class="form-check-label">
                  Deployed everything at once when able to
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="who_started" value="player1">
                <label class="form-check-label">
                  First Turn
                </label>
              </div>

              <div class="form-group mt-2">
                <label class="form-check-label">Player1's Magic Spells</label>
                <select class="form-select" size="5" name="player1_magic" multiple>
                  <optgroup label="Hereditary">
                    <option value="H">Hereditary</option>
                  </optgroup>
                  <optgroup label="Alchemy">
                    <option value="A1">1</option>
                    <option value="A2">2</option>
                    <option value="A3">3</option>
                    <option value="A4">4</option>
                    <option value="A5">5</option>
                    <option value="A6">6</option>
                  </optgroup>
                  <optgroup label="Cosmology">
                    <option value="C1">1</option>
                    <option value="C2">2</option>
                    <option value="C3">3</option>
                    <option value="C4">4</option>
                    <option value="C5">5</option>
                    <option value="C6">6</option>
                  </optgroup>
                  <optgroup label="Divination">
                    <option value="DV1">1</option>
                    <option value="DV2">2</option>
                    <option value="DV3">3</option>
                    <option value="DV4">4</option>
                    <option value="DV5">5</option>
                    <option value="DV6">6</option>
                  </optgroup>
                  <optgroup label="Druidism">
                    <option value="DR1">1</option>
                    <option value="DR2">2</option>
                    <option value="DR3">3</option>
                    <option value="DR4">4</option>
                    <option value="DR5">5</option>
                    <option value="DR6">6</option>
                  </optgroup>
                  <optgroup label="Evocation">
                    <option value="E1">1</option>
                    <option value="E2">2</option>
                    <option value="E3">3</option>
                    <option value="E4">4</option>
                    <option value="E5">5</option>
                    <option value="E6">6</option>
                  </optgroup>
                  <optgroup label="Occultism">
                    <option value="O1">1</option>
                    <option value="O2">2</option>
                    <option value="O3">3</option>
                    <option value="O4">4</option>
                    <option value="O5">5</option>
                    <option value="O6">6</option>
                  </optgroup>
                  <optgroup label="Pyromancy">
                    <option value="P1">1</option>
                    <option value="P2">2</option>
                    <option value="P3">3</option>
                    <option value="P4">4</option>
                    <option value="P5">5</option>
                    <option value="P6">6</option>
                  </optgroup>
                  <optgroup label="Shamanism">
                    <option value="S1">1</option>
                    <option value="S2">2</option>
                    <option value="S3">3</option>
                    <option value="S4">4</option>
                    <option value="S5">5</option>
                    <option value="S6">6</option>
                  </optgroup>
                  <optgroup label="Thaumaturgy">
                    <option value="T1">1</option>
                    <option value="T2">2</option>
                    <option value="T3">3</option>
                    <option value="T4">4</option>
                    <option value="T5">5</option>
                    <option value="T6">6</option>
                  </optgroup>
                  <optgroup label="Witchcraft">
                    <option value="W1">1</option>
                    <option value="W2">2</option>
                    <option value="W3">3</option>
                    <option value="W4">4</option>
                    <option value="W5">5</option>
                    <option value="W6">6</option>
                  </optgroup>
                </select>
              </div>


            </div>

            <div class="col">
              <!-- Player 2 -->

              <div class="form-group" data-bs-toggle="tooltip" data-bs-placement="top" title="EXAMPLE:
              Warriors of the Dark Gods
              830 - Exalted Herald, General
              830 - Exalted Herald
              964 - 24x Warriors, Great Weapon, Sloth, Standard Bearer (Zealots' Banner), Musician, Champion
              690 - 5x Feldraks, Paired Weapons, Standard Bearer (Wasteland Torch), Musician, Champion
              200 - Chimera
              490 - Feldrak Elder, Paired Weapons
              490 - Feldrak Elder, Paired Weapons
              4494
              ">
                <label for="player2_army">Player 2's List</label>
                <textarea id="player2_army" class="form-control shadow" name="player2_army" rows="3"
                  placeholder="new recruit format - first line must be army name"></textarea>
              </div>

              <div class="form-group mt-4 d-block d-none">
                <label id="player2_army_formatted_label">Player 2's List Formatted</label>
                <pre id="player2_army_formatted"></pre>
              </div>

              <div class="form-group mt-4">
                <label for="player2_name">Player 2's Name</label>
                <input type="text" class="form-control shadow" name="player2_name" placeholder="jane">
              </div>
              <div class="form-group mt-2">
                <label for="player2_score">Player 2's Score - Including Secondary</label>
                <input type="number" min="0" max="20" class="form-control shadow" name="player2_score" placeholder="20">
              </div>
              <div class="form-group mt-2">
                <label for="player2_vps">Player 2's Victory Points</label>
                <input type="number" class="form-control shadow" name="player2_vps" placeholder="0-4900">
              </div>




              <div class="form-check mt-2">
                <input class="form-check-input" type="radio" name="won_secondary" value="player2">
                <label class="form-check-label">
                  Won Secondary Objective
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="who_deployed" value="player2">
                <label class="form-check-label">
                  Deployed First
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="dropped_all" value="player2">
                <label class="form-check-label">
                  Deployed everything at once when able to
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="who_started" value="player2">
                <label class="form-check-label">
                  First Turn
                </label>
              </div>

              <div class="form-group mt-2">
                <label class="form-check-label">Player 2's Magic Spells</label>
                <select class="form-select" size="5" name="player2_magic" multiple>
                  <optgroup label="Hereditary">
                    <option value="H">Hereditary</option>
                  </optgroup>
                  <optgroup label="Alchemy">
                    <option value="A1">1</option>
                    <option value="A2">2</option>
                    <option value="A3">3</option>
                    <option value="A4">4</option>
                    <option value="A5">5</option>
                    <option value="A6">6</option>
                  </optgroup>
                  <optgroup label="Cosmology">
                    <option value="C1">1</option>
                    <option value="C2">2</option>
                    <option value="C3">3</option>
                    <option value="C4">4</option>
                    <option value="C5">5</option>
                    <option value="C6">6</option>
                  </optgroup>
                  <optgroup label="Divination">
                    <option value="DV1">1</option>
                    <option value="DV2">2</option>
                    <option value="DV3">3</option>
                    <option value="DV4">4</option>
                    <option value="DV5">5</option>
                    <option value="DV6">6</option>
                  </optgroup>
                  <optgroup label="Druidism">
                    <option value="DR1">1</option>
                    <option value="DR2">2</option>
                    <option value="DR3">3</option>
                    <option value="DR4">4</option>
                    <option value="DR5">5</option>
                    <option value="DR6">6</option>
                  </optgroup>
                  <optgroup label="Evocation">
                    <option value="E1">1</option>
                    <option value="E2">2</option>
                    <option value="E3">3</option>
                    <option value="E4">4</option>
                    <option value="E5">5</option>
                    <option value="E6">6</option>
                  </optgroup>
                  <optgroup label="Occultism">
                    <option value="O1">1</option>
                    <option value="O2">2</option>
                    <option value="O3">3</option>
                    <option value="O4">4</option>
                    <option value="O5">5</option>
                    <option value="O6">6</option>
                  </optgroup>
                  <optgroup label="Pyromancy">
                    <option value="P1">1</option>
                    <option value="P2">2</option>
                    <option value="P3">3</option>
                    <option value="P4">4</option>
                    <option value="P5">5</option>
                    <option value="P6">6</option>
                  </optgroup>
                  <optgroup label="Shamanism">
                    <option value="S1">1</option>
                    <option value="S2">2</option>
                    <option value="S3">3</option>
                    <option value="S4">4</option>
                    <option value="S5">5</option>
                    <option value="S6">6</option>
                  </optgroup>
                  <optgroup label="Thaumaturgy">
                    <option value="T1">1</option>
                    <option value="T2">2</option>
                    <option value="T3">3</option>
                    <option value="T4">4</option>
                    <option value="T5">5</option>
                    <option value="T6">6</option>
                  </optgroup>
                  <optgroup label="Witchcraft">
                    <option value="W1">1</option>
                    <option value="W2">2</option>
                    <option value="W3">3</option>
                    <option value="W4">4</option>
                    <option value="W5">5</option>
                    <option value="W6">6</option>
                  </optgroup>
                </select>
              </div>



            </div>
          </div>
          <div class="row mt-4"></div>
          <!-- Map and objective info -->

          <div class="row justify-content-center">
            <div class="col">
              <div class="form-group">
                <label for="map_selected">Map</label>
                <select class="form-control shadow" name="map_selected">
                  <option></option>
                  <option>Other</option>
                  <option>A1</option>
                  <option>A2</option>
                  <option>A3</option>
                  <option>A4</option>
                  <option>A5</option>
                  <option>A6</option>
                  <option>A7</option>
                  <option>A8</option>
                  <option>B1</option>
                  <option>B2</option>
                  <option>B3</option>
                  <option>B4</option>
                  <option>B5</option>
                  <option>B6</option>
                  <option>B7</option>
                  <option>B8</option>
                </select>
              </div>

              <div class="form-group mt-2">
                <label for="deployment_selected">Deployment</label>
                <select class="form-control shadow" name="deployment_selected">
                  <option></option>
                  <option>Other</option>
                  <option>1 Frontline Clash</option>
                  <option>2 Dawn Assault</option>
                  <option>3 Counter Thrust</option>
                  <option>4 Encircle</option>
                  <option>5 Refused Flank</option>
                  <option>6 Marching Columns</option>
                </select>
              </div>
            </div>

            <div class="col">
              <div class="form-group">
                <label for="objective_selected">Secondary Objective</label>
                <select class="form-control shadow" name="objective_selected">
                  <option></option>
                  <option>Other</option>
                  <option>1 Hold the Ground</option>
                  <option>2 Breakthrough</option>
                  <option>3 Spoils of War</option>
                  <option>4 King of the Hill</option>
                  <option>5 Capture the Flags</option>
                  <option>6 Secure Target</option>
                </select>
              </div>

              <div class="form-group mt-2">
                <label class="form-check-label">
                  Game Date
                </label>
                <input class="form-control shadow" type="date" name="game_date">
              </div>
            </div>
          </div>



          <div class="row mt-4"></div>
          <!-- Submit button -->

          <div class="row justify-content-center">
            <div class="col-md-4 d-flex justify-content-center">
              <button id="submit_btn" type="submit" class="btn btn-primary shadow-lg"
                aria-disabled="false">Submit</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!-- Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous"></script>
  <script>
    // Allow users to uncheck the radio buttons in case of miss click
    window.onload = function () {
      document.querySelectorAll("INPUT[type='radio']").forEach(function (rd) {
        rd.addEventListener("mousedown", function () {
          if (this.checked) {
            this.onclick = function () {
              this.checked = false
            }
          } else {
            this.onclick = null
          }
        })
      })

      // Display results from formatter
      console.log("adding event listeners")
      const player1_army = document.getElementById("player1_army");
      player1_army.addEventListener("focusin", showWaitingMessage);
      player1_army.addEventListener("focusout", showDisplayFormattedArmy);

      const player2_army = document.getElementById("player2_army");
      player2_army.addEventListener("focusin", showWaitingMessage);
      player2_army.addEventListener("focusout", showDisplayFormattedArmy);

      // Force initial state to be valid for the second player
      document.getElementById("player2_army_formatted").setAttribute("validated", true)
    }

    const waitingMessage = " -- Waiting for focus change"

    function showWaitingMessage(evt) {
      console.log("hiding " + evt.currentTarget.id);
      const label = document.getElementById(evt.currentTarget.id + "_formatted_label");
      label.innerText += waitingMessage;
    }

    function showDisplayFormattedArmy(evt) {
      console.log("showing " + evt.currentTarget.id);
      const formatted = document.getElementById(evt.currentTarget.id + "_formatted");
      const label = document.getElementById(evt.currentTarget.id + "_formatted_label");

      formatArmy(evt.currentTarget.value).then(formattedArmy => {
        btn = document.getElementById("submit_btn");
        formatted.setAttribute("validated", formattedArmy.validated); //store if its formatting is ok or not

        if (
          (
            // Both are validated correctly
            document.getElementById("player1_army_formatted").getAttribute("validated") === 'true'
            && document.getElementById("player2_army_formatted").getAttribute("validated") === 'true'
          )
          ||
          (
            // 1 is valid and 2 is blank
            document.getElementById("player1_army_formatted").getAttribute("validated") === 'true'
            && document.getElementById("player2_army").value === ""
          )
        ) { //if both are ok
          btn.disabled = false; //enable the submit button
          btn.setAttribute("aria-disabled", "false");
        } else {
          btn.disabled = true; //there was an error, disable the submit button
          btn.setAttribute("aria-disabled", "true");
        }

        formatted.innerText = formattedArmy.data;
        label.innerText = label.innerText.replace(waitingMessage, "");
        formatted.parentElement.classList.remove('d-none');

      })
    }

    async function formatArmy(data) {
      const options = {
        method: "POST",
        headers: new Headers({ 'content-type': 'application/json', "Accept": "application/json", "User-Agent": "ninthage-data-reporter/1.1.0" }),
        body: JSON.stringify({ "data": data })
      };

      console.log("fetching")
      let response = await fetch("https://www.9thbuilder.com/en/api/v1/builder/imports/format", options);
      if (response.status != 200) {
        return { "validated": false, "data": "ERROR: Formatting failed, please ensure army follows the new recruit format." };
      } else {
        // Display list errors
        let json_data = await response.json();
        if (json_data.validation.hasError) {
          returnString = ""
          json_data.validation.errors.forEach(error => {
            returnString = returnString.concat(error.message, "\n");
          })
          return { "validated": false, "data": returnString };
        } else {
          // return formatted version of the army
          return { "validated": true, "data": json_data.formated };
        }
      }

    }

  </script>
</body>

</html>